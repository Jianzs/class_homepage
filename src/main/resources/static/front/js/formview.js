var isValidate=true;function initRadio(){$("li[typ='radio']","#fields").each(function(g,r){var e=$(r),n=e.find("div.content");if(e.has("fieldset").length>0){n=n.find("fieldset")}if(e.attr("random")=="1"){var d=[],k=n.children();if(k.length==0){k=n.find(">label")}var q=$(k[k.length-1]).find(":radio").hasClass("other"),m,f=k.length;if(q){m=k[k.length-1];f=k.length-1}while(d.length<f){var o=Math.random();o=Math.round(o*(f-1));if($.inArray(o,d)===-1){d.push(o)}}n.empty();for(j=0;j<f;j++){n.append(k[d[j]])}if(q){n.append(m)}n.prepend(n.find("p.instruct"))}n.find(">label:eq(0)").addClass("first");var b=function(){var s=$(this).parent().parent(),l=$.trim($(this).val());if(!l){l="其它"}s.find(":radio.other").val(l)};n.find(":text.other").bind({keyup:b,change:b,click:function(c){$(this).parent().parent().find(":radio.other").prop("checked",true);highlight(c,this)}})});if(!window.isForMobile){var a=null;$(":radio").bind({click:function(b){if(a===this){$(a).prop("checked",false).trigger("change");a=null}else{a=this;if($(this).hasClass("other")){$(this).parent().find(":text.other").focus()}}b.stopPropagation()}});$("table.table td").click(function(){var b=$(this).find(":radio");b.attr("checked",true)})}}function initUpload(){var b=function(d){var k;if($("#_id").val()){var m=d.find("div.content"),l=m.find("input.fileSize").attr("name"),g=m.find("input.fileId").attr("name"),f=m.find("input.fileType").val(),e=[g.substring(0,l.indexOf("_")),m.find("input.fileType").attr("name"),l.substring(0,l.indexOf("_")),m.find("input.fileName").attr("name")];k={ENTRYID:$("#_id").val(),FRMID:$("#FRMID").val(),FILEID:m.find("input.fileId").val(),FILETYPE:f,FILEFIELDS:e,FLDID:d.attr("id")}}else{k={FRMID:$("#FRMID").val(),FLDID:d.attr("id")}}return k},a=function(d,e){var f=d.find("div.content");if(e.status==="success"){d.removeClass("error").find("p.errMsg").remove();f.find("div.uploadedFile").show();if($.isImage(e.fileName)){f.find("span.uploadedFileName").html($.format('<img class="img-edit" src="{0}" />',IMAGEURL+e.fileId+e.fileType+FILEIMAGEEDITSTYLE))}else{f.find("span.uploadedFileName").text($.format("{0}({1})",e.fileName,$.formatFileSize(e.fileSize)))}f.find("input.fileId").val(e.fileId).trigger("change");f.find("input.fileName").val(e.fileName).trigger("change");f.find("input.fileSize").val(e.fileSize).trigger("change");f.find("input.fileType").val(e.fileType).trigger("change")}else{if(e.status==="error"){showErrorMsg(d,$.format(msg[e.errCode],e.msg));f.find("input.fileId").val("").trigger("change");f.find("input.fileName").val("").trigger("change");f.find("input.fileSize").val("").trigger("change");f.find("input.fileType").val("").trigger("change")}}$("#btnSubmit").prop("disabled",false);$.hideStatus()};$("#fields").find("input.file").each(function(e,d){var g=$(d),c=g.parent().parent(),k;g.localResizeIMG({cprs:c.attr("cprs"),quality:0.5,before:function(l,f){k=$(l).val().match(/[^\/\\]*$/)[0];$.showStatus("正在上传文件...")},unsupport:function(){ajaxUpload(c)},success:function(f){var l=$.extend(b(c),{IMAGENAME:k,IMAGEDATA:f.clearBase64});if(l.FILEFIELDS){l.FILEFIELDS=l.FILEFIELDS.join(",")}jQuery.ajax({url:"/web/formview/compressandupload",data:l,type:"post",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(n,m){a(c,n);$.hideStatus()},error:function(n,m,o){showErrorMsg(c,$.format(msg.uploadError,o));isValidate=true;$("#btnSubmit").prop("disabled",false);$.hideStatus();return false}})}})});$("a.deleteIcon","#fields").live({click:function(){if(!$(this).parent().find("img").attr("src")){$(this).parent().remove()}else{var m;if(arguments.length==2){m=arguments[1].notShowConfirm}if(m=="1"||confirm("删除后不可恢复，确认删除吗？")){var s=$(this).parents(".content"),r=$(this).parent(),k,n="/web/formview/deletefile";if($("#_id").val()){var t=s.find("input.fileSize").attr("name"),e=s.find("input.fileId").attr("name"),v=s.find("input.fileType").val(),g=[e.substring(0,t.indexOf("_")),s.find("input.fileType").attr("name"),t.substring(0,t.indexOf("_")),s.find("input.fileName").attr("name")];var o=$(this).parent().index();var l=$(this).parents("li").find(".fileName").val().split(",")[o];var f=$(this).parents("li").find(".fileId").val().split(",")[o];var q=l.split(".").length;k={ENTRYID:$("#_id").val(),FRMID:$("#FRMID").val(),FILEID:f,FILETYPE:"."+l.split(".")[q-1],FILEFIELDS:g,INITTIME:INITTIME};n="/web/entries/deletefile"}else{var o=$(r).index();k={FRMID:$("#FRMID").val(),FILEID:s.find("input.fileId").val().toString().split(",")[o],FILETYPE:s.find("input.fileType").val().toString().split(",")[o]}}$.showStatus("正在删除文件...");$.postJSON(n,k,function(G){if(G){$.alert(G.ERRMSG);$.hideStatus();return}var C=$(r).index();var d=s.find("input.fileId").val().toString().split(",");var z=s.find("input.fileName").val().toString().split(",");var x=s.find("input.fileSize").val().toString().split(",");var E=s.find("input.fileType").val().toString().split(",");d.splice(C,1);z.splice(C,1);x.splice(C,1);E.splice(C,1);r.remove();var D=s.find("input.fileId"),B=s.find("input.fileName"),y=s.find("input.fileSize"),c=s.find("input.fileType");D.val(d).trigger("change");B.val(z).trigger("change");y.val(x).trigger("change");c.val(E).trigger("change");if($("#_id").val()){var A={};A[D.attr("name").split("_")[0]]=d.join(",");A[B.attr("name").split("_")[0]]=z.join(",");A[y.attr("name").split("_")[0]]=x.join(",");A[c.attr("name").split("_")[0]]=E.join(",");$.postJSON("/web/formview/updateentry",{FRMID:$("#FRMID").val(),ENTRYID:$("#_id").val(),DATA:A},function(){})}$.hideStatus()})}}var u=$("p.error","#fields").length;if(!u){$(".selectfiles").prop("disabled",false);$("#btnSubmit").prop("disabled",false);$("#btnSave").removeClass("disabled");$("#btnCancelSave").prop("disabled",false)}return false}})}var calShopCard=function(){var k=false,a,l,g,n,d,b,f=0,o=0,m=0;$("#fields>li[TYP='goods']").each(function(r,q){a=$(q);l=$("#ul"+a.attr("id")).empty();if(!a.is(":visible")){return true}a.find("div.goods-item").each(function(s,t){var u=$(t);d=parseFloat(u.find("input.number").val())||0;n=u.find("div.price").text();g=parseFloat(n.replace(/[¥$£€]/,""))||0;b=u.find("label.name").text();if(d>0){l.append($.format("<li><span class='goods-name'>{0}</span><span class='price-number'>{1} × {2}</span></li>",b,n,d));m+=d*g;k=true}})});m=m.toFixed(2);f=m;var c=parseFloat($("#shopping_cart").find("span.salem").text())||0,e=parseFloat($("#shopping_cart").find("span.salej").text())||0;if(c>0&&e>0){o=(Math.floor(m/c)*e).toFixed(2);f=(m-o).toFixed(2)}$("#amount").val(f);if(k){$("#shopping_cart").show().find("span.total").text(m).end().find("span.amount").text(f);if(o>0){$("#shopping_cart").find("div.discount-container").show().find("span.discount").text(o)}else{$("#shopping_cart").find("div.discount-container").hide()}}else{$("#shopping_cart").hide()}};function initGoods(){$("#fields div.goods-item a.decrease,#fields div.goods-item a.increase").click(function(){var d=$(this).parent(),b=d.find("input.number"),a=parseFloat(b.val())||0;if(b.prop("disabled")){return false}if($(this).hasClass("decrease")){if(a>=1){b.val(--a)}}else{b.val(++a)}calShopCard();return false});$("#fields div.goods-item").find("input.number").bind({blur:function(){calShopCard()}});$("#fields div.goods-item").find("input.number").trigger("blur")}function initAuthCode(){var a=function(b,d){d.click(function(){var g=$(this).attr("tmpidx"),f=$("#btnSendCode"+g),k=b.getValidate();if(!k){$.alert("请先完成验证。");return false}if(f.hasClass("disabled")){return false}var e=$("div.content").has(f).find("input.phone").val();if(!$.isMobile(e)){$.alert("请输入正确的手机号码。");return false}$.ajax({url:"/web/VerifyLoginServlet",type:"post",dataType:"json",data:{geetest_challenge:k.geetest_challenge,geetest_validate:k.geetest_validate,geetest_seccode:k.geetest_seccode,TEL:e,TYP:"form",FRMID:$("#FRMID").val(),SIGN:f.attr("SIGN")},success:function(n){if(n&&(n.status==="success")){var m=f.attr("tmpidx"),o=$("#btnSendCode"+m);o.text("120").prop("disabled",true).addClass("disabled");var l=setInterval(function(){var q=parseInt(o.text());if(q>0){o.text(--q)}else{o.text("发送验证码").prop("disabled",false);o.removeClass("disabled");clearInterval(l)}},1000);if(n.sendcount<=0){clearInterval(l);o.text("发送验证码").prop("disabled",false).removeClass("disabled");$.alert("发送验证码失败：可用短信量不足，需要充值，请与表单创建者联系。")}return false}else{$.alert("验证失败")}}});return false});var c=d.attr("tmpIdx");b.bindOn("#btnSendCode"+c);b.appendTo("#popupCaptcha"+c)};if($("#fields").find("button.sendcode").length>0){$("#fields").find("button.sendcode").each(function(c,b){$.ajax({url:"/web/StartCaptchaServlet",type:"get",dataType:"json",success:function(d){initGeetest({gt:d.gt,challenge:d.challenge,product:"popup",offline:!d.success},function(e){a(e,$(b))})}})})}}function initInstruct(){var a=$("#fields>li");$.each(a,function(d,b){var e=$(b).find("p.instruct").removeClass("hide");var f=$(b).attr("id");if(f&&f.indexOf("au")==0){var c=f.substr(2);$("#"+c).find("div.content").prepend(e)}else{$(b).find("div.content").prepend(e)}})}function initAddress(){$("#fields>li[typ='address']").each(function(d,b){b=$(b);var f=b.attr("def"),a,g=b.find("select.province"),k=b.find("select.city"),e=b.find("select.zip"),c="";if(f){a=f.split("-")}$.each(address.provinces,function(m,l){c+=$.format("<option value='{0}'>{1}</option>",m,m)});g.append(c);g.change(function(){var l=$(this).val();k.empty().append("<option value=''>市</option>");e.empty().append("<option value=''>区/县</option>");if(l){var m="";$.each(address.provinces[l],function(o,n){m+=$.format('<option value="{0}">{1}</option>',o,o)});k.append(m)}});k.change(function(){var l=b.find("select.province").val(),n=$(this).val();e.empty().append("<option value=''>区/县</option>");if(n){var m="";$.each(address.provinces[l][n],function(q,o){m+=$.format('<option value="{0}">{1}</option>',o,o)});e.append(m)}});if(a&&a[0]){g.val(a[0]);g.trigger("change")}if(a&&a[1]){k.val(a[1]);k.trigger("change")}if(a&&a[2]){e.val(a[2])}})}function initMap(){$("#fields").find("div.map").each(function(f,s){var q=$(s).parent(),g=q.find("input.location"),e=q.find("input.j"),r=q.find("input.w"),m=q.find("button.getlocation,button.getlocation1"),t=q.find("button.marker");var d,o,n;var a=function(v){e.val(v.longitude);r.val(v.latitude);var u=new AMap.LngLat(v.longitude,v.latitude);d.clearMap();var c=new AMap.Marker({});c.setPosition(u);c.setMap(d);d.setCenter(u);n.getAddress(u)};var b=function(c){var u={};u.latitude=c.position.getLat();u.longitude=c.position.getLng();a(u)},l=function(){if(typeof(CURPOS)==="undefined"||(CURPOS.longitude==undefined||CURPOS.latitude==undefined)){$.alert("获取地址位置失败，请检查GPS是否打开，然后重试一次。")}else{a(CURPOS)}$.hideStatus()},k=function(c){g.val(c.regeocode.formattedAddress);g.removeClass("hide").show();g.trigger("change");m.text("重新获取").parent();$.hideStatus()};var d=new AMap.Map($(s).attr("id"),{zoom:13});d.plugin(["AMap.Geolocation","AMap.Geocoder"],function(){o=new AMap.Geolocation({});n=new AMap.Geocoder({radius:1000,extensions:"all"});d.addControl(o);AMap.event.addListener(o,"complete",b);AMap.event.addListener(o,"error",l);AMap.event.addListener(n,"complete",k)});$(s).data("map",d);AMap.event.addListener(d,"click",function(v){d.clearMap();var c=new AMap.Marker({});e.val(v.lnglat.getLng());r.val(v.lnglat.getLat());var u=new AMap.LngLat(v.lnglat.getLng(),v.lnglat.getLat());c.setPosition(u);c.setMap(d);n.getAddress(u)});m.click(function(){$.showStatus();o.getCurrentPosition()});t.click(function(){var c=q.find("div.map");if(!c.hasClass("hide")){c.addClass("hide")}else{c.removeClass("hide")}q.find("input.location").show();return false});g.change(function(){if(!$(this).val()){e.val("");r.val("")}})})}function highlight(d,b){var a=$("li").has(b),c=a.attr("typ");$("li.focused").removeClass("focused");if(!a.hasClass("error")){a.addClass("focused")}d.stopPropagation()}function initYzjMenu(){var b=$("#formHeader h2").text();if($.isYzjApp()&&!window.ISMBLEDIT){XuntongJSBridge.call("setWebViewTitle",{title:b});var a=[{text:"我的表单",callBackId:"myFormButton"},{text:"我的报表",callBackId:"myReportButton"},{text:"创建表单",callBackId:"newFormButton"},{text:"我的账户",callBackId:"myAccountButton"}];XuntongJSBridge.call("createPop",{popTitle:"...",popTitleCallBackId:"",items:a,menuList:["forward","refresh","openWithBrowser"],shareData:{isShowExt:true,title:b,description:"帮您玩转企业数据，提高营销效率、降低管理成本",appName:"表单大师"}},function(c){if(c.success==true||c.success=="true"){var d=c.data?c.data.callBackId:"";if(d=="newFormButton"){window.location.href="/app/formbuilderm1.jsp"}else{if(d=="myAccountButton"){window.location.href="/app/account/manage"}else{if(d){window.location.href="/app/form/manage"}}}}})}}function initFocus(){if(window.isForMobile){$("#fields").find(".controlgroup>label,table.table label").bind({click:function(a){a.stopPropagation()}});$("[typ='file']").click(function(){if(!$(this).hasClass("focused")){$("li.focused").removeClass("focused");var a=$(this).attr("typ");if(a!="section"&&a!="html"&&a!="image"&&a!="goods"){$(this).addClass("focused").end().find(":input:eq(0)").focus()}}});return}$(".fld").bind({click:function(a){highlight(a,this)},focus:function(a){highlight(a,this)}});$("#fields>li[id]").click(function(){if(!$(this).hasClass("focused")){$("li.focused").removeClass("focused");var a=$(this).attr("typ");if(a!="section"&&a!="html"&&a!="image"&&a!="goods"){$(this).addClass("focused").end().find(":input:eq(0)").focus()}}})}function updateSelects(a,b){var d=$(b).is("li")?$(b):$(b).parent().parent();if(a&&d.find("input.yyyy").length>0){d.find("input.yyyy").val(a.getFullYear());d.find("input.mm").val($.formatHH(a.getMonth()+1));d.find("input.dd").val($.formatHH(a.getDate()));d.find("input.val").val($.getDate(d)).trigger("change")}else{d.find("input.val").val(a).trigger("change")}}function initNumberInput(){var e=function(m){var l=m.find("input.tel1").val(),k=m.find("input.tel2").val(),g=m.find("input.tel3").val();if(l||k){return $.format("{0}-{1}-{2}",l,k,g)}else{return""}},f=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/^\+\D/g,""));l.find(".val").val(e(l))},b=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/\D/g,""));l.find(".val").val($.getTime(l)).trigger("change")},d=function(k){var g=$(this).val(),l=$(this).parent().parent();$(this).val(g.replace(/\D/g,""));l.find(".val").val($.getDate(l)).trigger("change")},c=function(m){if(window.isForMobile){var k=$(this).attr("maxlength");if(!k){k=16}var g=$(this).val();if(g.length>k){$(this).val(g.slice(0,k))}return}var l=$(this).val();$(this).val(l.replace(/[^(\-?\d\.?)]/g,"").replace(/[\(\)\?]/g,""))},a=function(){var g=$(this).val(),k=$(this).parent().parent();$(this).val(g.replace(/-/g,""));k.find(".val").val($.getName(k)).trigger("change")};$("select.hh,select.mi","#fields").live({change:function(){var l=$(this).parent().parent(),k=l.find("select.hh").val(),g=l.find("select.mi").val();if(k&&g){l.find(".val").val($.format("{0}:{1}",k,g))}else{l.find(".val").val("")}}});$("input.yyyy,input.mm,input.dd","#fields").bind({keyup:d,change:d});$("input.number,input.money","#fields").bind({keyup:c,change:c});$("input.n1,input.n2,input.n3","#fields").bind({keyup:a,change:a});$("input.authcode,input.phone,input.tel1,input.tel2,input.tel3","#fields").bind({keyup:f,change:f})}function initDropdown2(){var a=5;for(var b=1;b<a;b++){$("#fields").find("select.dd"+b).bind({change:function(){var e=$(this).find("option:selected").attr("items");var f=[];if(e){f=JSON.parse(e)}else{f.push({VAL:""})}var d=parseInt($(this).attr("level"));var c=$(this).parent().find("select.dd"+(d+1));c.empty();$.each(f,function(g,k){if(k.ITMS){c.append($.format("<option items='{0}' value='{1}'>{1}</option>",JSON.stringify(k.ITMS),k.VAL))}else{c.append($.format("<option value='{0}'>{0}</option>",k.VAL))}});c.trigger("change")}}).trigger("change")}}FieldRelation={fillAutoCompValue:function(a){var c=a.val(),b=a.attr("matfrm"),e=a.attr("matfld"),d=a.data("liids");if(c&&b&&e){$.postJSON("/web/formview/getmatchvalue",{FRMID:b,FLD:e,VAL:c,EXFLDS:"",FLDS:a.data("matflds"),EXMAT:"1"},function(f){if(f.length>0){FieldRelation.setAutoCompValue(d,f[0])}})}},getMatchedText:function(b){var a=b.indexOf(",");if(a>0){return b.substring(0,a)}else{return b}},updown:function(f,e){var c=$(f),d=c.parent().find("ul.matul"),b=d.find("li").length,l=d.find("li.selected"),k=l.index(),g=c.data("oldval");if(e==40){if(k<b-1){l.removeClass("selected");var a=d.find("li:eq("+(k+1)+")");a.addClass("selected");c.val(a.text())}else{l.removeClass("selected");c.val(g)}}else{if(e==38){if(k>0){l.removeClass("selected");var a=d.find("li:eq("+(k-1)+")");a.addClass("selected");c.val(a.text())}else{if(k==0){l.removeClass("selected");c.val(g)}else{var a=d.find("li:eq("+(b-1)+")");a.addClass("selected");c.val(a.text())}}}}},getmatchdata:function(k,d){var f=d.which;if(f==40||f==38||f==13){FieldRelation.updown(k,f);return false}var a=$(k),m=a.val(),b=a.attr("matfrm"),n=a.attr("matfld"),l=a.attr("exmat");p=a.position(),h=a.outerHeight(),w=a.innerWidth();var c=a.parent().find("ul.matul"),g=$("#fields>li").has(a).attr("ex");a.data("oldval",m);if(m){$.postJSON("/web/formview/getmatchvalue",{FRMID:b,FLD:n,VAL:m,EXFLDS:g?JSON.parse(g).matfld:"",FLDS:a.data("matflds"),EXMAT:l},function(e){if(c.length==0){c=$("<ul class='matul'></ul>");a.after(c)}c.css("top",p.top+h);c.css("left",p.left);c.css("minWidth",w);c.empty().show();$.each(e,function(s,q){var t=new RegExp("("+a.data("oldval")+")","g");var u="<li>"+q[n].replace(t,"<i>$1</i>");if(g){var r=JSON.parse(g).matfld.split(",");$.each(r,function(v,x){if(x&&q[x]){u+=","+q[x]}})}u+="</li>";var o=$(u);o.data("data",q);c.append(o);o.bind({mouseover:function(){$(this).addClass("selected")},mouseout:function(){if($(this).is(":visible")){$(this).removeClass("selected")}},mousedown:function(){var x=$(this).parent(),v=x.parent().find("input.fld");FieldRelation.setAutoCompValue(v.data("liids"),$(this).data("data"));v.val(FieldRelation.getMatchedText($(this).text()));$(this).addClass("selected");x.hide()}})})})}else{c.hide()}},setAutoCompValue:function(c,b){var a=function(d,f){var l=d.find("select.province"),m=d.find("select.city"),e=d.find("select.zip"),k=d.find("textarea.detail"),g=d.attr("acmpfld").split(",");l.val("");m.val("");e.val("");k.val("");if(f[g[0]]){l.val(f[g[0]]).trigger("change")}if(f[g[1]]){m.val(f[g[1]]).trigger("change")}if(f[g[2]]){e.val(f[g[2]])}if(f[g[3]]){k.val(f[g[3]])}};$.each(c,function(k,q){if(!q){return true}var s=$("#"+q),n=s.attr("acmpfld"),o=s.attr("typ"),e=s.attr("fmt"),r=b[n];if(o!="radio"&&o!="checkbox"){s.find("input").val("");s.find("input[name]").val(r||"")}var f=":text";if(o=="date"){$.setDate(s,r)}else{if(o==="time"){$.setTime(s,r);f="input"}else{if(o==="name"){$.setName(s,r)}else{if(o==="phone"){$.setPhone(s,r)}else{if(o=="dropdown"){s.find("select[name]").val("");s.find("select[name]").val(r||"");f="select"}else{if(o=="radio"){s.find("input[name]").prop("checked",false);s.find("input[value='"+r+"']").trigger("click");if(s.find("input:radio[value='"+r+"']").length==0&&s.find("input:radio.other").length!=0){s.find("input:radio.other").prop("checked",true);s.find("input.other[type='text']").val(r)}f=":radio"}else{if(o=="address"){a(s,b);f="select"}else{if(o=="name"){$.setName(s,r)}else{if(o=="image"){var m=n.split(","),d=b[m[0]],l=b[m[1]],g="";if(d&&l){g=d.split(",")[0]+l.split(",")[0]}if($.isImage(g)){s.find(".image-img").attr("src",IMAGEURL+g)}else{s.find(".image-img").attr("src","/rs/images/defaultimg.png")}}else{if(o=="textarea"){s.find("textarea[name]").val("");s.find("textarea[name]").val(r||"")}}}}}}}}}}if(f==":checkbox"){s.find(f).trigger("click")}else{s.find(f).trigger("change")}if(o=="date"){s.find("input.val").val(r)}if(o=="address"){a(s,b)}})}};function initMatchAndAcmp(){$("#fields").find("input[matfrm],select[matfrm]").each(function(i,_txt){var txt=$(_txt),ex=$("#fields>li").has(txt).attr("ex"),nm=txt.attr("name"),matfld=txt.attr("matfld"),fields=[matfld],liids=[];if(ex){var obj=JSON.parse(ex);if(obj.matfld){var matflds=obj.matfld.split(",");$.each(matflds,function(i,v){fields.push(v);liids.push(null)})}}$("#fields>li[acmpsrcfld]").each(function(j,li){var l=$(li),acmpsrcfld=l.attr("acmpsrcfld"),acmpfld=l.attr("acmpfld");if((nm==acmpsrcfld||nm.indexOf(acmpsrcfld+"_")>-1)&&acmpfld){fields.push(acmpfld);liids.push(l.attr("id"))}});if(txt.is("select")){txt.bind({change:function(){var acmpData=eval("("+$(this).find("option:selected").attr("acmp")+")");FieldRelation.setAutoCompValue(liids,acmpData)}})}else{txt.data("matflds",fields);txt.data("liids",liids);var keyupTime;var str="",now="",filter_time=function(e){var time=setInterval(function(){filter_staff_from_exist(e)},500);txt.bind("blur",function(){clearInterval(time)})},filter_staff_from_exist=function(e){now=$.trim(txt.val());if(now!=str){FieldRelation.getmatchdata(txt,e)}str=now};txt.bind({focus:function(e){str=$.trim(txt.val());filter_time(e)},keyup:function(e){keyupTime=new Date().getTime(),_this=$(this);var keycode=e.which;if(keycode==40||keycode==38){FieldRelation.getmatchdata(_this,e);now=$.trim(txt.val());str=now;return false}},keypress:function(e){var keycode=e.which;if(keycode==13){var txt=$(_txt),ul=txt.parent().find("ul.matul"),li=ul.find("li.selected"),idx=li.index(),oldVal=txt.data("oldval");if(idx>=0){txt.val(FieldRelation.getMatchedText(txt.val()));FieldRelation.setAutoCompValue(txt.data("liids"),li.data("data"))}ul.hide();return false}},blur:function(){var txt=$(_txt),ul=txt.parent().find("ul.matul"),li=ul.find("li.selected"),idx=li.index();if(idx>=0){FieldRelation.setAutoCompValue(txt.data("liids"),li.data("data"))}else{}ul.hide()}})}})}function initFieldsPermForView(){if(window.ADVPERM&&"1"==ADVPERM.VIEWPERM){$("#fields").find("li").each(function(c,b){var a=$(b);if("1"==ADVPERM.VIEWPERM&&$.inArray(a.attr("id"),ADVPERM.VIEWFLDS)==-1){var d=a.attr("typ")||"";if($.inArray(d,["image","html","section",""])==-1){a.addClass("hide")}}})}}function showErrorMsg(a,b){isValidate=false;a.addClass("error");if(a.find("p.errMsg").length===0){a.append("<p class='errMsg'></p>")}a.find("p.errMsg").text(b);$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false);$.hideStatus()}function initValidate(){var b=function(){var l=$("li").has(this),k=parseInt(l.attr("max")),g=$(this).val().length;if(l.find("span.lengthLimit").length===0){l.find("label.desc").append("<span class='lengthLimit'></span>")}if(k-g>=0){l.find("span.lengthLimit").text($.format(msg.lengthLimit,k-g))}else{$(this).val($(this).val().substring(0,k));l.find("span.lengthLimit").text($.format(msg.lengthLimit,0))}},d=function(){isValidate=true;var g=$("#fields").find("li[id]:visible"),k=true,z,q,D,G,r,B,A,J,y,t;for(i=0;i<g.length;i++){z=$(g[i]);t=true;q=z.attr("TYP"),D=z.attr("MIN"),G=z.attr("MAX"),r=z.attr("REQD"),B=z.attr("UNIQ"),A=z.attr("DEF"),J=z.attr("name"),y;if(r==="1"){var H=true;if(q==="radio"){var C=z.find(":checked");if((C.val()&&!C.hasClass("other"))||(C.hasClass("other")&&$.trim(z.find(":text").val()))){H=false}}else{if(q==="checkbox"||q==="likert"){if(z.find(":checked").length>0){H=false}}else{if(q==="goods"){z.find("div.goods-item input.number").each(function(K,v){if((parseFloat($(v).val())||0)>0){H=false;return false}})}else{if(q==="address"){var l=z.find("select.province").val(),E=z.find("select.city").val(),I=z.find("select.zip").val();if(l&&E&&I){H=false}}else{z.find(":input[name]").each(function(v,K){if($.trim($(K).val())){H=false;return}})}}}}if(H){k=false;t=false;showErrorMsg(z,msg.reqdError);continue}}if(D){y=z.find("input,textarea").val();if(y){if(q==="number"||q==="money"){if(parseFloat(y)<parseFloat(D)){k=false;t=false;showErrorMsg(z,$.format(msg.minNumberError,D));continue}}}if(q==="text"||q==="textarea"){if(y.length!=0&&y.length<parseFloat(D)){k=false;t=false;showErrorMsg(z,$.format(msg.minTextError,D));continue}}else{if(q=="checkbox"){if(z.find(":checkbox:checked").length<parseFloat(D)){k=false;t=false;showErrorMsg(z,$.format(msg.minChkError,D));continue}}}}if(G){y=z.find("input,textarea").val();if(y){if(q==="number"||q==="money"){if(parseFloat(y)>parseFloat(G)){k=false;t=false;showErrorMsg(z,$.format(msg.maxNumberError,G));continue}}}if(q==="text"||q==="textarea"){if(y.length!=0&&y.length>parseFloat(G)){k=false;t=false;showErrorMsg(z,$.format(msg.maxTextError,G));continue}}else{if(q=="checkbox"){if(z.find(":checkbox:checked").length>parseFloat(G)){k=false;t=false;showErrorMsg(z,$.format(msg.maxChkError,G));continue}}}}if(q==="number"||q==="money"){y=z.find(":input[name]").val();if(y!=""&&!$.isNumber(y)){k=false;t=false;showErrorMsg(z,msg.numberError);continue}}else{if(q==="date"){y=z.find(":input[name]").val();if(y!=""&&!$.isDate(y)){k=false;t=false;showErrorMsg(z,msg.dateError);continue}}else{if(q==="email"){y=z.find(":input[name]").val();if(y!=""&&!$.isEmail(y)){k=false;t=false;showErrorMsg(z,msg.emailError);continue}}else{if(q==="phone"){var x=z.find(":input[name]"),m=x.attr("fmt"),y=x.val();if(y&&m=="mobile"&&!$.isMobile(y)){k=false;t=false;showErrorMsg(z,msg.mobileError);continue}}else{if(q==="table"){var s=z.find("td[typ='email']");if(s&&s.length>0){$.each(s,function(K,v){var M=$(v);var L=M.find("input").val();if(L&&!$.isEmail(L)){k=false;t=false;showErrorMsg(M,msg.emailError)}})}}}}}}if(t){z.removeClass("error");z.find("p.errMsg").remove()}}var n=localStorage.getItem($("#FRMID").val()+"_DTLMT");var u=localStorage.getItem($("#FRMID").val()+"_DTLMT_TIME");var o=$.formatDate(new Date());if(u===o&&typeof DTLMT!="undefined"&&DTLMT.DTLMT>0&&n>=DTLMT.DTLMT){k=false;if(typeof TIPTEXT!="undefined"&&TIPTEXT.DTLMT){$.alert(TIPTEXT.DTLMT)}else{$.alert("已经提交过了，请不要重复提交，如有疑问请与表单发布者联系。")}}return k},c=function(r){var g=$("li").has(r),l=g.find(":input[name]"),m=l.attr("name"),k=l.val(),o=false;var q={FRMID:$("#FRMID").val(),SID:$("#SID").val(),ENTRYID:$("#_id").val(),NM:m,VAL:k};$.postJSON("/web/formview/existValidate",q,function(n){o=!n;if(!o){if(typeof TIPTEXT!="undefined"&&TIPTEXT.UNIQ){showErrorMsg(g,TIPTEXT.UNIQ)}else{showErrorMsg(g,msg.uniqError)}}},{async:false});return o},f=function(m){var g=$("li").has(m),k=true;var l={kaptcha:g.find(":input[name='kaptcha']").val()};$.postJSON("/web/formview/captchaValidate",l,function(n){k=n;if(!k){showErrorMsg(g,msg.captchaError)}},{async:false});return k},a=function(g){var k=$("#"+g.attr("id").substring(2)),l=true;var m={TEL:k.find("input.phone").val(),CODE:g.find("input.authcode").val()};$.postJSON("/web/formview/authcodevalidate",m,function(n){l=n;if(!l){showErrorMsg(g,msg.authCodeError)}},{async:false});return l},e=function(){var g=true;$.postJSON("/web/formview/checklimit",$("#form1").getValues(),function(k){if(k&&k.length>0){$.hideStatus();$.each(k,function(m,l){if("goods"==l.TYP){g=false;showErrorMsg($("[name='"+l.NM+"_"+l.TYP+"']","#fields").parents("div.goods-item"),$.format("{0}限购数量为{1},还可以购买{2}({3}),你已超出限购数量,需修改。",l.VAL,l.AMOUNTLMT,l.BALANCE,l.UNT))}else{g=false;showErrorMsg($("[name='"+l.NM+"_"+l.TYP+"']","#fields").parents("li"),$.format("{0}限制提交数量为{1},还可以提交{2}次,你已超出提交限制,需修改。",l.VAL,l.AMOUNTLMT,l.BALANCE))}});return false}},{async:false});return g};$("li[max]:has(textarea)","#fields").find("textarea").bind({keyup:b,change:b});$("#btnSubmit,#btnSave,#btnActSave").bind({click:function(){if($(this).hasClass("disabled")||$(this).prop("disabled")){return false}var m=$("#_id").val()?"edit":"new";if(m=="new"&&"1"==ADVPERM.ADV&&!"1"==ADVPERM.ADD){$.alert("没有新增数据的权限，请与管理员联系。");return false}$.each(RULE.FIELDSRULE||[],function(t,u){$.each(u.RULEFLD||[],function(v,x){if(!$("#"+x).is(":visible")){$("#"+x+",#au"+x).setValues({},true)}})});calShopCard();if(!d()){$("#fields").find("li.error:first").find(":input").focus();return false}$(this).prop("disabled",true);$.showStatus("正在验证数据...");if($("#liCaptcha").length>0){isValidate=f($("#liCaptcha").find(":text"))}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}var s=$("li[uniq='1']");if(s.length>0){s.each(function(u,t){isValidate=c($(t).find(":input[name]"));if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}})}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}$("#fields input.authcode").each(function(t,u){var v=$(u);isValidate=a($(v).parent().parent());if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}});if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}var q=$("li[ctlmt='DAY'], li[ctlmt='ALL']");if(q.length>0){isValidate=e();if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();return false}}if(!isValidate){$("#fields").find("li.error:first").find(":input").focus();$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false);$.hideStatus();return false}else{var m=$("#_id").val()?"edit":"new";if(m==="new"){var l=parseFloat($("#TMOUT").val());$("#TMOUT").val(Math.round((new Date().getTime()-l)/1000))}var k=$("#form1").find("li[typ!=table]").getValues();var o=$("#form1>input").getValues();$.mergJSON(k,o);$.each($("#form1>input[type='hidden']"),function(v,u){var t=$(u).attr("name");var x=$(u).val();k[t]=x});var n=$("#fields li[typ=table]");$.each(n,function(v,x){var u=$(x).find("div.tbl").attr("name");k[u]=[];var t=$(x).find("div.tbl tr:gt(0)");$.each(t,function(y,z){var A=$(z).getValues();k[u].push(A)})});$.each(k,function(u,t){if(/^t\d/.test(u)){delete k[u]}});if($(this).attr("id")==="btnSubmit"){if($("#FRMID").attr("autofill")=="1"){localStorage.setItem($("#FRMID").val(),JSON.stringify(k))}else{localStorage.removeItem($("#FRMID").val())}if(typeof DTLMT!="undefined"&&DTLMT.DTLMT>0){var r=localStorage.getItem($("#FRMID").val()+"_DTLMT");if(r==null){r=0}else{r=parseInt(r)}r++;localStorage.setItem($("#FRMID").val()+"_DTLMT",r);localStorage.setItem($("#FRMID").val()+"_DTLMT_TIME",$.formatDate(new Date()))}else{localStorage.removeItem($("#FRMID").val()+"_DTLMT");localStorage.removeItem($("#FRMID").val()+"_DTLMT_TIME")}$.showStatus("正在保存数据...");var g="/web/formview/"+$("#FRMID").val();$.postJSON(g,k,function(t){$.hideStatus();var u=t&&t.url;if(!u){u="/web/viewresult"}window.location.href=u})}else{$.showStatus("正在保存数据...");k.INITTIME=$.trim(INITTIME.toString());k.FRMNM=FRM.FRMNM;$.postJSON("/web/entries/save",k,function(t){if(t&&t.ERRMSG){$.alert(t.ERRMSG);$.hideStatus();return}$.closeLightBox();if(window.query){if(m==="new"){query(null,"FIRST",PAGESIZE,$("#entriesGrid").datagrid("getSortString"),$("#entriesGrid"))}else{if("1"==ADVPERM.ADV&&"1"==ADVPERM.FLT){query(null,"FIRST",PAGESIZE,$("#entriesGrid").datagrid("getSortString"),$("#entriesGrid"))}else{var u=$("#entriesGrid"),y=u.data("rowsData"),x=u.data("total"),v=u.find("tbody>tr.rowSelected").index();if(t.REALNAME&&t.REALNAME!=t.CBY){t.CBY=$.format("{0}({1})",t.CBY,t.REALNAME)}y[v]=t;u.data("rowsData",y);u.datagrid("fillData",{total:x,rows:y});u.find("tbody>tr:eq("+v+")").addClass("rowSelected");$("a.view").click(function(){setTimeout(function(){$("#btnActView").trigger("click")},150)});$("a.edit").click(function(){setTimeout(function(){$("#btnActEdit").trigger("click")},150)});window.selectedData=t;$("#btnActVie").trigger("click")}}$.hideStatus()}else{if(!window.isForMobile){$.alert("保存成功")}else{$.malert("保存成功，正在跳转...",function(){window.location.href=document.referrer+$.format("#l{0}",liIndex||0)})}$.hideStatus()}$("#btnSubmit,#btnSave,#btnActSave").prop("disabled",false)});return false}}return false}})}var getDateByReg=function(d){var f,b=/^\+?(-?\d+) ?[Dd]ays$/,e=/^\+?(-?\d+) ?[Ww]eeks$/,c=/^\+?(-?\d+) ?[Mm]onths$/,a=new Date();if(d==="today"){return a}else{if(b.test(d)){f=parseInt(d.replace(b,"$1"));return a.addDate("d",f)}else{if(e.test(d)){f=parseInt(d.replace(e,"$1"));return a.addDate("w",f)}else{if(c.test(d)){f=parseInt(d.replace(c,"$1"));return a.addDate("m",f)}else{if($.isDate(d)){return Date.fromString(d)}}}}}},getTimeByReg=function(d){var e,b=/^\+?(-?\d+) ?[Mm]inutes$/,c=/^\+?(-?\d+) ?[Hh]ours$/,a=new Date();if(d==="now"){return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if(b.test(d)){e=parseInt(d.replace(b,"$1"));a=a.addDate("n",e);return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if(c.test(d)){e=parseInt(d.replace(c,"$1"));a=a.addDate("h",e);return $.format("{0}:{1}",$.formatHH(a.getHours()),$.formatHH(a.getMinutes()))}else{if($.isTime(d)){return d}}}}};function setSubTblValue(a,c){a.find("div.tbl tr").filter(function(d){return d>=2}).remove();var b=0;if(c&&c.length>0){$.each(c,function(e,d){var g=a.find("div.tbl tr:last-child");if(b>0){var k=$(g).clone();$.each($(k).find("td"),function(m,n){if($(n).attr("typ")=="radio"){var l=$(n).find("input[type=radio]");$.each(l,function(s,o){var r=$(o).attr("name");var q=r.split("_");r=q[0]+"_"+q[1]+"_"+e;$(o).attr("name",r)})}});$(k).setValues(d,true);$(g).after(k)}else{$(g).setValues(d,true)}g=a.find("div.tbl tr:last-child");var f=$(g).find("td");$.each(f,function(l,m){if($(m).attr("typ")=="date"){$.setDate($(m),$(m).find("input.val").val())}else{if($(m).attr("typ")=="time"){$.setTime($(m),$(m).find("input.val").val())}}});b++})}}function setDefaultValue(b){if(window.ISMBLEDIT){return}if(b){$("#fields").setValues({},true);$("#fields").find("select.dd1").trigger("change")}else{var k=localStorage.getItem($("#FRMID").val());if(k&&$("#FRMID").attr("autofill")=="1"){try{var f=JSON.parse(k);if(window.countLmtInfo&&countLmtInfo.length>0){$.each(countLmtInfo,function(m,l){var e=l.NM+"_"+l.TYP;delete f[e]})}$("#fields").setValues(f,true);var c=$("#fields").find("li[TYP='table']");if(c&&c.length>0){var a=$(c[0]).find("div.tbl").attr("name");var d=f[a];setSubTblValue($(c[0]),d)}setTimeout(function(){var e=false;$("#fields").find("li").each(function(o,n){if(e){return false}var m=$(n),q=m.attr("typ");if(q=="goods"){m.find("div.number-container").each(function(s,t){if(e){return false}var r=$(t),l=r.find("input.number");if(f[l.attr("name")]){e=true;return false}})}});if(e){calShopCard()}},0);$.each($("#fields").find("input[type=hidden]"),function(n,m){var l=$(m).attr("name");if(l&&l.indexOf("time")>0){var o=$(m).val();var q=$(m).parent().parent();$.setTime(q,o)}else{if(l&&l.indexOf("date")>0){var e=$(m).val();var q=$(m).parent().parent();$.setDate(q,e)}else{if($(m).hasClass("w")||$(m).hasClass("j")){}else{$(m).val("")}}}});$("#fields").find("li[typ='goods']").find("input.number").trigger("blur")}catch(g){}}}if(window.QPARAMS){$("#fields").setValues(window.QPARAMS,true,true);$.each(window.QPARAMS,function(m,l){var e=$(":text[name='"+m+"']");if(e.length>0&&e.attr("matfrm")&&e.attr("matfld")){FieldRelation.fillAutoCompValue(e)}})}$("li[def]","#fields").each(function(m,l){l=$(l);var r,o=l.attr("typ"),q=l.attr("def");if(!q){return}if(o==="date"){updateSelects(getDateByReg(q),l)}else{if(o==="time"){$.setTime(l,getTimeByReg(q))}else{if(o==="phone"){var e=q.split("-");if(e.length>0){$(e).each(function(s,n){l.find(":text:eq("+s+")").val(n)})}l.find(":input[name]").val(q)}else{if(o==="radio"){l.find(":radio:eq("+q+")'").prop("checked",true)}else{if(o==="dropdown"){}else{if(o==="likert"){l.find("tbody>tr").each(function(n,s){$(s).find(":radio:eq("+q+")'").prop("checked",true)})}else{l.find("input.fld,textarea.fld").val(q)}}}}}}})}function initRule(){var d=function(k,g){var l=true;if(k==="or"){l=false}$.each(g,function(o,m){var r=true,n=$(":input[name='"+m.FLD+"']"),t;if(n.length===0){n=$(":input[name^='"+m.FLD+"_']")}t=n.val();if(n.is(":checkbox")||n.is(":radio")){t=undefined;n.each(function(u,v){if($(v).prop("checked")){t=$(v).val();return false}})}if(m.CTYP==="eq"){if(m.DTYP==="filesize"){r=parseInt(t)===parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)===parseFloat(m.VAL)}else{if(m.DTYP==="date"){r=t===$.formatDate(getDateByReg(m.VAL))}else{r=t===m.VAL}}}}else{if(m.CTYP==="ne"){if(m.DTYP==="filesize"){r=parseInt(t)!=parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)!=parseFloat(m.VAL)}else{r=t!=m.VAL}}}else{if(m.CTYP==="bw"){if(t!=null&&t!=undefined){r=t.indexOf(m.VAL)===0}}else{if(m.CTYP==="ew"){var q=new RegExp("("+m.VAL+")$","gi");r=q.test(t)}else{if(m.CTYP==="ct"){if(t!=null&&t!=undefined){r=t.indexOf(m.VAL)>=0}}else{if(m.CTYP==="nct"){if(t!=null&&t!=undefined){r=t.indexOf(m.VAL)===-1}}else{if(m.CTYP==="in"){var s=m.VAL.split(";");r=$.inArray(t,s)>=0}else{if(m.CTYP==="nin"){var s=m.VAL.split(";");r=$.inArray(t,s)===-1}else{if(m.CTYP==="gt"){if(m.DTYP==="filesize"){r=parseInt(t)>parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)>parseFloat(m.VAL)}else{r=t>m.VAL}}}else{if(m.CTYP==="gte"){if(m.DTYP==="filesize"){r=parseInt(t)>=parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)>=parseFloat(m.VAL)}else{r=t>=m.VAL}}}else{if(m.CTYP==="lt"){if(m.DTYP==="filesize"){r=parseInt(t)<parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)<parseFloat(m.VAL)}else{if(t){r=t<m.VAL}else{r=false}}}}else{if(m.CTYP==="lte"){if(m.DTYP==="filesize"){r=parseInt(t)<=parseFloat(m.VAL)*1024*1024}else{if(m.DTYP==="number"){r=parseFloat(t)<=parseFloat(m.VAL)}else{if(t){r=t<=m.VAL}else{r=false}}}}}}}}}}}}}}}if(!r&&k==="and"){l=false;return false}if(r&&k==="or"){l=true;return false}});return l},c=function(g){$.each(RULE.FIELDSRULE||[],function(k,m){if(g){var l=false;$.each(m.CONS,function(q,o){if(g==o.FLD||g.indexOf(o.FLD+"_")==0){l=true;return false}});if(!l){return true}}var n=d(m.ANDOR,m.CONS);if(!(m.RULEFLD instanceof Array)){m.RULEFLD=[m.RULEFLD]}$.each(m.RULEFLD,function(q,o){if(n){if(m.RULETYPE==="show"){$("#"+o+",#au"+o).removeClass("hide")}else{$("#"+o+",#au"+o).addClass("hide")}}else{if(m.RULETYPE==="show"){$("#"+o+",#au"+o).addClass("hide")}else{$("#"+o+",#au"+o).removeClass("hide")}}});if("goods"==$("#"+m.RULEFLD).attr("typ")){calShopCard()}});if(window.isForMobile&&window.fileUpload){fileUpload()}};if(window.RULE&&RULE.FIELDSRULE&&RULE.ENABLERULE==="1"){$.each(RULE.FIELDSRULE,function(g,k){if(k.RULETYPE==="show"){if(!(k.RULEFLD instanceof Array)){k.RULEFLD=[k.RULEFLD]}$.each(k.RULEFLD,function(m,l){$("#"+l).addClass("hide")})}});$(":text,input,select").change(function(){var g=$(this).attr("name");setTimeout(function(){c(g)})});$(":radio,:checkbox").click(function(){var g=$(this).attr("name");c(g)});c()}$("#container").removeClass("hide");var e=function(){if(window.RULE&&window.RULE.ENABLERULE=="1"&&RULE.EXPRESSRULE&&RULE.EXPRESSRULE.length>0){var g=0;$.each(RULE.EXPRESSRULE,function(n,l){var q=l.split("=");if(q.length!=2){return true}var o=q[0],k=q[1],m,r={};$.each(FLDS,function(u,t){if(t.NM==o){if(t.TYP=="number"){m=t.NM+"_number"}return false}});var s=k.split(/[\+\-\*\/\(\)]/ig);$.each(s,function(t,u){if(!u||u.indexOf("F")!=0){return true}$.each(FLDS,function(x,v){if(v.NM==u){if(v.TYP=="number"){r[v.NM]=v.NM+"_number"}return false}})});$.each(r,function(u,t){g++;$("[name="+t+"]","#fields").bind("change",function(A){var y=arguments[1];if(!y){y=1}else{y++}if(y>g){$(this).unbind("change");$.alert("检测到表单设置的逻辑运算表达式存在死循环，请联系表单创建者。");return false}else{try{var v=[],z=true;var B=k.split(/[\+\-\*\/\(\)]/ig);$.each(B,function(C,D){if(!D||D.indexOf("F")!=0){return true}var E=$("[name="+D+"_number]","#fields").val();if(!E){z=false;return false}else{v.push(E)}});if(z){var x=$.calc(k,v);if(x!=x||x==Infinity||x==-Infinity){$("[name="+m+"]","#fields").val("")}else{if(x||x==0){$("[name="+m+"]","#fields").val(x);$("[name="+m+"]","#fields").trigger("change",y)}}}}catch(A){}}})})})}};e();var f=$("#form1").find("[acmpsrcfld][acmpfld][typ='image'] img");if(f.length>0){for(var a=0;a<f.length;a++){var b=$(f[a]).attr("src");if(typeof(b)!="undefined"&&b.length<50){$("#form1").find("[acmpsrcfld][acmpfld][typ='image'] img:eq("+a+")").attr("src","/rs/images/defaultimg.png")}}}}function onBridgeReady(){WeixinJSBridge.call("hideOptionMenu")}function initWeixinShare(){if(window.F&&F.DISSHARE==="1"){if(typeof WeixinJSBridge=="undefined"){if(document.addEventListener){document.addEventListener("WeixinJSBridgeReady",onBridgeReady,false)}else{if(document.attachEvent){document.attachEvent("WeixinJSBridgeReady",onBridgeReady);document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)}}}else{onBridgeReady()}}}function initOthers(){$("#TMOUT").val(new Date().getTime());$("#imgKaptcha").click(function(){$(this).attr("src","/kaptcha.jpg?"+Math.floor(Math.random()*100))});if($("#needBuyInfo").length>0){$("#btnSubmit").prop("disabled",true)}$("#cornerQrcode").click(function(){var a=$("#qrcode");if(!a.attr("src")){a.attr("src","/qrcode.jpg?type=formview&c="+$("#FRMID").val())}$("#qrcodeContainer").show()});$("#qrcode").click(function(){setTimeout(function(){$("#qrcodeContainer").hide()},10)});calShopCard()}function initLogo(){var b=$("#container").attr("mobile");if(b){var c=$("#logo").find("a"),g=c.css("backgroundSize");if("cover"==g){var f=c.css("backgroundImage");if(f){var e=f.substring(f.indexOf("(")+1,f.lastIndexOf(")")).replace(/\"/g,"");var d=$($.format("<img src='{0}' style='border:none;width:100%;' />",e));c.append(d);d.load(function(){c.css({backgroundImage:"none",backgroundSize:"initial",height:$(this).height()})})}}}}function initImg(){if(!window.query&&!window.isForMobile){$("#fields>li").find("div.content div.goods-item img.img").live("click",function(){var a=$(this).attr("src");$.lightBox({url:"#stage",size:"l cus3",showclose:"0",loaded:function(){$("img.img-option","#stage").attr({src:a});$("img.img-option","#stage").unbind().click(function(){$.closeLightBox()})}});return false})}}function initCommitLmt(){if(typeof countLmtInfo!="undefined"&&countLmtInfo.length>0){for(var b=0;b<countLmtInfo.length;b++){var c=countLmtInfo[b];var a;if(c.TYP=="radio"){a=$("input[name='"+c.NM+"_"+c.TYP+"'][value='"+c.VAL+"']");a.parent().append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="dropdown"){a=$("select[name='"+c.NM+"_"+c.TYP+"']").find("option[value='"+c.VAL+"']");a.append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="checkbox"){a=$("#"+c.NM);a.parent().append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}else{if(c.TYP=="goods"){a=$("input[name='"+c.NM+"_"+c.TYP+"']");a.parents("div.text-wrapper").find("label.name").append("<label style='color:#ccc;'>(剩余"+c.BALANCE+")</label>")}}}}if(c.BALANCE==0){a.prop("disabled","disabled")}}}}function initSubFormOptAction(){if(window.isForMobile){$("li[typ='table']","#fields").find("div.tbl").addClass("hide")}$("div.rowAdd").live({click:function(){var b=$(this);if(window.isForMobile){$.lightBox({url:"#stage",size:"s",showclose:"0",btnConfirm:"#btnConfirm1, #btnConfirm2",loaded:function(){window.console.log("=======build sub table=======");$("ul","#stage").remove();var l=b.prev().find("table tr:last-child");var k=$(l).clone();var c=b.prev().find("table tr:first-child");var e=$(c).clone();var n=e.find("th");var q=k.find("td");var f=$("<ul class='fields'></ul>");$("#stage").prepend(f);for(var g=1;g<n.length;g++){var d=$(n[g]).attr("typ");var m=$(n[g]).text();var o=$("<li class='clearfix' typ='"+d+"'></li>");o.append("<label class='desc'>"+m+"</label>");o.append($(q[g]).html());f.append(o)}$("#stage").setValues({},true)},confirm:function(){window.console.log("======= confirm =======");a(b,$("#stage").getValues());var c=$(event.target).attr("id");if("btnConfirm1"==c){$("#stage").setValues({});return false}}});return}a(b)}});function a(g,d){var e=g.prev().find("table tr:last-child");var c=$(e).siblings().length;if(c==1&&$(e).hasClass("hide")){$(e).removeClass("hide");$(e).prev().removeClass("hide");return}else{if(c>=200){$.alert("超出最大限制数，不能新增行。");return}}var f,b;if($(e).parents("div.tbl").hasClass("hide")){b=false;$(e).parents("div.tbl").removeClass("hide");f=$(e)}else{b=true;f=$(e).clone()}$.each(f.find("td"),function(n,o){if($(o).attr("typ")=="radio"){var m=$(o).find("input[type=radio]");$.each(m,function(t,k){var s=$(k).attr("name");var r=s.split("_");var q=r[0]+"_"+r[1];if(d){d[q]=d[s]}$(k).attr("name",q)})}else{if($(o).attr("typ")=="date"){var l=$(o).find(".datepincker");l.removeClass("hasDatepicker");l.attr("id",l.attr("id")+"_"+n);$(o).find("img.ui-datepicker-trigger").remove();$.initDate($(o),updateSelects)}}});if(!window.isForMobile){$(f).setValues({},true)}else{$(f).setValues(d,true)}if(b){$(e).after(f)}refreshItemNameAndId(e)}$("div.tbl table tr td a.icononly-del").live({click:function(){var b=$(this).parent().parent();var c=$(b).siblings().length;if(c>1){$(b).remove()}else{$(b).addClass("hide");$(b).prev().addClass("hide")}}})}function refreshItemNameAndId(c){var d=$(c).parent().children();for(var b=1;b<d.length;b++){$.each($(d[b]).find("td"),function(f,g){if($(g).attr("typ")=="radio"){var e=$(g).find("input[type=radio]");$.each(e,function(n,k){var m=$(k).attr("name");var l=m.split("_");m=l[0]+"_"+l[1]+"_"+(b-1);$(k).attr("name",m);a($(k))})}else{if($(g).attr("typ")=="checkbox"){var e=$(g).find("input[type=checkbox]");$.each(e,function(l,k){a($(k))})}}})}function a(f){var g=f.attr("id");if(!g){return}var e=g.split("_")[0]+"_"+(b-1);f.attr("id",e);f.next("label").attr("for",e)}}head.ready(function(){if(isEmbed){$("body").css({background:"none",padding:"0px",margin:"0px"});$("#form1").css({marginTop:"0px"});$("#container").css({width:"100%","box-shadow":"none"}).find("#form1").css({"padding-top":"20px"});$("#logo").hide()}initYzjMenu();initFocus();initInstruct();initRadio();initNumberInput();initGoods();initMap();initAddress();initAuthCode();initValidate();initMatchAndAcmp();setDefaultValue();initRule();initDropdown2();initFieldsPermForView();initLogo();initUpload();$.initDate($("#fields"),updateSelects);initOthers();initWeixinShare();initImg();initCommitLmt();initSubFormOptAction();var a=$("#container").attr("mobile");if(a){var b=$("#container").height(),c=$(window).height()-6;if(b<c){$("#container").css({minHeight:c})}}});